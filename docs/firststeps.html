<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><title>Первые шаги</title>
<META http-equiv=Content-Type content="text/html; charset=Windows-1251">
<LINK href="misc/styles.css" type="text/css" rel=stylesheet>
</HEAD>
<BODY>

<H2>Первые шаги к созданию SFX архива *</H2>
<p>Все больше пользователей выбирают для установки приложений самораспаковывающиеся архивы (далее "SFX архивы"), а в качестве архиватора предпочитают использовать архиватор 7-Zip. Это <b>бесплатный</b> архиватор, распространяющийся по лицензии GNU LGPL. Если вы с ним не знакомы, то более подробную информацию сможете найти на <a class="ext" target="_blank" href="http://www.7-zip.org/">сайте 7-zip</a>. Его отличает более высокая степень сжатия, а с модифицированным SFX модулем доступны абсолютно незаметная (silent) установка, возможность распаковки файлов в заданную папку, добавление ярлыков в меню Пуск и на рабочий стол, а также многие другие функции.</p>
<p>Область применения SFX архивов не ограничивается приложениями, не требующими установки. Можно без проблем упаковать приложение, запакованное одним из распространенных инсталляторов и сконфигурировать SFX архив таким образом, что бы после распаковки была запущена установка приложения с нужными ключами.<br>
Еще одним преимуществом SFX архивов является то, что в некоторых случаях они дают возможность не просто автоматизировать, но и полностью скрыть процесс и ход установки от конечного пользователя. Для примера рассмотрим упаковку "<b>Adobe Reader 7.0</b>". Хотя приложение можно устанавливать с соответствующими ключами, но только SFX архив позволяет установить приложение абсолютно незаметно.</p>
<p><font color="#a82323"><b>Подготовка к созданию SFX архива</b></font></p>
<p>Если вы хотите просто запаковать папку с файлами, то никакой подготовки не требуется. А вот приложения иногда приходится распаковывать. В случае с "Adobe Reader 7" используется "Install Shield" с "Basic MSI", причем все это еще и запаковано в некий "FEAD Optimizer". Процесс извлечения нужных файлов выходит за рамки этой справки. Просто скажем, что все извлеченные файлы необходимо поместить в одну папку.</p>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p>Теперь нужно запаковать содержимое этой папки в 7z архив. Сделать это можно через "7-Zip File Manager". Запустив его, перейдите в папку, в данном случае "Archive", в которой находятся подготовленные файлы "Adobe Reader 7", выделите все файлы и нажмите <b>Добавить</b> (значок в виде большого зеленого плюса).</p></td>
		<td class="form"><p><IMG alt="7zip main" src="misc/7zip_main.png"></p></td>
	</TR>
</TBODY>
</table>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p><IMG alt="7zip parameters" src="misc/7zip_parameters.png"></p></td>
		<td class="form"><p>В появившемся окне введите имя архива (здесь "Archive.7z") и выберите:</p>
<ul>
	<li>Формат архива: <b>7z</b>
	<li>Уровень сжатия: <b>Ультра</b>
	<li>Метод сжатия: <b>LZMA</b></li>
</ul>
		<p>Если Вы в дальнейшем планируете изменять ваш SFX архив (добавлять/ заменять/ удалять файлы) то установите:</p>
<ul>
	<li>Размер блока: <b>По размеру файла</b></li>
</ul>
		<p>Правда последняя опция несколько уменьшит степень сжатия, но за все надо платить. Поэтому, если размер архива для Вас главное, оставьте эту опцию по умолчанию - <b>Непрерывный</b>.</p>
		<p>Затем нажмите кнопку <b>ОК</b>. В результате получите файл "Archive.7z", из которого нам предстоит сделать SFX архив.</p></td>
	</TR>
</TBODY>
</table>
<p><font color="#a82323"><b>Файл конфигурации</b></font></p>
<p>Теперь нужно создать файл конфигурации для SFX архива. Его можно сделать в "Блокноте". В нашем случае он будет выглядеть так:</p>
<pre class="pre40">;!@Install@!UTF-8!
RunProgram="Reader7Rus.msi /qn"
GUIMode="2"
;!@InstallEnd@!</pre> 
<p>Выглядит сложно, но сейчас все прояснится.<br>
Первая и последние строки просто обозначают начало и конец файла конфигурации.<br>
Вторая строка - команда, которая будет выполнена после распаковки архива. Команда заключается в кавычки и помещается после параметра '<tt>RunProgram</tt>'.<br>
Третья строка полностью скрывает диалоговое окно распаковки.<br>
Сохраните файл конфигурации (ОБЯЗАТЕЛЬНО в кодировке <b>UTF-8</b>) под именем "config.txt" в папку, где находится "Archive.7z", и переходите к завершающей стадии создания SFX архива.</p>
<p><font color="#a82323"><b>Создание SFX архива</b></font></p>
<p>Скопируйте модуль "7ZSD_LZMA.sfx" в папку с файлами "Archive.7z" и "config.txt" (например, "C:\7z_test").</p>
<p>Теперь, когда в одной папке собраны все три файла ("Archive.7z",	"config.txt" и "7ZSD_LZMA.sfx"), выполните из командной строки следующую команду (порядок следования файлов в команде ОБЯЗАТЕЛЕН):</p>
<pre class="pre40">COPY /b 7ZSD_LZMA.sfx + config.txt + Archive.7z AdobeReader7.exe</pre>
<p>Через мгновение в папке появится SFX архив - файл "AdobeReader7.exe". Его запуск произведет распаковку архива во временную папку, запуск команды из конфигурационного файла, а по окончании установки удаление временной папки.</p>
<p><font color="#a82323"><b>&nbsp;&nbsp;&nbsp; <A id="rem">Примечание</b></font>: Если Вы не знакомы с работой в консоли, то следует учесть следующее: </p>
<ul>
	<li>Команду нужно выполнять из папки с указанными файлами.<br>
	Для этого нажмите [Win+R], введите <b>cmd /k</b> и нажмите [Enter].<br>
	Затем в открывшемся окне консоли введите <b>cd путь_к_папке_с_файлами</b> (например, <b>cd C:\7z_test</b>) и нажмите [Enter].<br>
	И только теперь введите указанную выше командную строку.
	<li>Если в пути и/или имени файла имеются пробелы, то 
  такие имена и/или пути_имена должны быть заключены в кавычки.</li>                 
</ul>
<p><A id="icon"></A><font color="#a82323"><b>Замена иконки 7z sfx архива.</b></font></p>
<p>Цель замены иконки состоит в том, чтобы иметь вашу собственную иконку, которая будет отображаться в диалоговых окнах SFX архива, панели задач, а так же и в оболочке Windows. Ниже показано отображение файла ("Установка Total Commander") с измененной иконкой из примера №6 данной справки.</p>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p><IMG alt="Veiw TC" src="misc/Example6_BeginPrompt.png"></p></td>
		<td class="form"><p><IMG alt="Veiw TC" src="misc/Change_icon0.png"></p></td>
	</TR>
</TBODY>
</table>
<p><b>ВАЖНО!</b> Менять иконку можно только у НЕСЖАТЫХ UPX-ом модулей. Ниже будет описан процесс <A class=int href="#upx">сжатия модуля</A>.</p>
<p>В этом коротком руководстве мы используем "<a href="http://www.angusj.com/resourcehacker/" target="_blank" class= "ext">Resource Hacker</a>" (541 кб). Его русскую версию можно найти в интернете.</p>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p><IMG alt="Change icon 1" src="misc/Change_icon1.png"></p></td>
		<td class="form"><p>Загрузите, распакуйте zip архив и запустите программу "Resource Hacker". Перетащите и отпустите модуль в окно программы, или используйте комбинацию клавиш [<b>CTRL+O</b>], чтобы выбрать модуль. Разверните узел <b>Icon Group</b>, затем узел <b>101</b> и щелкните <b>0</b>, как показано ниже.</p>
		<p>Вы увидите иконки, которые есть в модуле. Теперь мы заменим их своими иконками. Щелкните меню <b>Действия</b>, и выберите опцию <b>Переместить значок...</b>. Появится окно изображенное ниже.</p></td>
	</TR>
</TBODY>
</table>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p>Щелкните кнопку <b>Откройте новый значок...</b>, выберите иконку, которую Вы хотели бы видеть в диалогах SFX архива. Слева в окне Вы видите новую иконку, а справа - старую, заменяемую иконку модуля. Щелкните кнопкой<b> Переместить</b>. </p></td>
		<td class="form"><p><IMG alt="Change icon 2" src="misc/Change_icon2.png"></p></td>
	</TR>
</TBODY>
</table>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p><IMG alt="Change icon 3" src="misc/Change_icon3.png"></p></td>
		<td class="form"><p>Нажмите комбинацию клавиш [<b>CTRL+S</b>], чтобы сохранить модуль с измененной иконкой. По умолчанию "Resource Hacker" использует 	для нового файла первоначальное имя исходного файла, но переименовывает исходный файл, добавляя к его имени "<b>_original</b>".</p>
		<p>Обратите внимание, что новая иконка имеет шесть форматов вместо двух в исходном модуле. Вполне достаточно всего двух форматов 16х16 и 32х32 и даже одного. Остальные, перед указанными выше операциями по замене иконки, могут/должны быть удалены любым редактором иконок, т.к. только увеличивают размер модуля. Так иконка, упомянутого в примере №4 "Media Player Classic", имеет десять форматов, и ее размер составляет 139кб!!! Windows, в случае необходимости, самостоятельно "сделает" и отобразит недостающий формат (например, 48х48), как это показано на <A class=int href="#icon">правом рисунке</A> в начале данного раздела.</p></td>
	</TR>
</TBODY>
</table>
<p>Все готово! Теперь все ваши SFX архивы, созданные с новым модулем, будут иметь выбранную Вами иконку.</p>
<p><A id="upx"></A><font color="#a82323"><b>Сжатие модуля</b></font></p>
<p>Для еще большего уменьшения размера SFX архива можно сжать модуль бесплатной утилитой <a class="ext" target="_blank" href="http://upx.sourceforge.net/">UPX</a>. Однако, SFX архивы, созданные при помощи сжатых модулей, МОГУТ вызвать ложное срабатывание некоторых антивирусных программ, о чем Вы теперь предупреждены.</p>
<p>Если Вы решите и сжать модуль UPX-ом, и поменять его иконку, то сжимать модуль нужно только ПОСЛЕ смены иконки. Обратная последовательность операций (сначала сжатие, а потом смена иконки) НЕДОПУСТИМА, т.к. приведет к созданию неработоспособного модуля и созданных на его основе SFX архивов.</p>
<p>Сжатие UPX-ом уменьшает размер модуля примерно в два раза. Для этого нужно, чтобы заранее скачанный и распакованный UPX находился в одной папке с упаковываемым модулем. Выполните из командной строки следующую команду:</p>
<pre class="pre40">upx --best 7ZSD_LZMA.sfx</pre>
<p>В результате Вы получите сжатый модуль. Достаточно это сделать один раз, и в дальнейшем использовать сжатый модуль.</p>
<p><font color="#a82323"><b>&nbsp;&nbsp;&nbsp; <A id="rem0">Примечание</b></font><A id="rem1">:</A> см. <A class=int href="#rem">здесь</A>.</p>
<p>&nbsp;</p>
<p><A id="repack"></A><font color="#a82323"><b>Изменение имеющегося SFX архива</b></font></p>
<p>Иногда возникает желание посмотреть, как устроен "чужой" SFX архив или необходимость переделать его, чтобы добавить в него новые команды или просто изменить внешний вид его диалоговых окон. Если достаточно только файла конфигурации, то его можно извлечь из SFX архива с помощью ключа '<A class=int href="switches.html#sfxconfig">-sfxconfig</A>'.</p>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p>Более универсальным инструментом является "7z SFX Archive splitter" (ссылка на <A class=int href="download.html">странице загрузки</A>). Перетащите на значок "7z SFX Archive Splitter"-а нужный SFX архив (для примера все тот же "AdobeReader7.exe") или выберете его с помощью кнопки "Обзор" (на которую указывает курсор на рисунке). Затем отметьте все составные части SFX архива (или только необходимые) и щелкните кнопку <b>OK</b>. В папке с "AdobeReader7.exe" появятся еще 3 файла с именем SFX архива (AdobeReader7), и расширениями .sfx (SFX модуль), .txt (файл конфигурации), .7z (7z архив).</p></td>
		<td class="form"><p><IMG alt=Splitter src="misc/Splitter.png"></p></td>
	</TR>
</TBODY>
</table>
<p>Теперь Вы можете сделать все необходимые модификации файлов.</p>
<p>Если Вы захотите добавить/ заменить/ удалить файлы в 7z архив, то можете столкнуться с ошибкой вроде "Не поддерживается". Она возникает, если 7z архив является Solid (непрерывным) архивом, т.е. он был создан с параметром Размер блока: отличным от <b>По размеру файла</b> (см. выше). (В старых версиях архиватора 7-Zip для создания Solid архива была отдельная опция <b>Создать Solid архив</b>.) Здесь выход только один - извлечь все содержимое архива во временную папку, произвести все изменения в ней, а затем запаковать все обратно в 7z архив, как описано выше.</p>
<p>Предположим, Вы хотите добавить диалоговое окно с сообщением о завершении установки и с таймером на 10 с. Файл конфигурации должен выглядеть так:</p>
<pre class="pre40">;!@Install@!UTF-8!
RunProgram="fm10:Reader7Rus.msi /qn"
GUIMode="2"
FinishMessage="Adobe Reader 7 установлен!"
;!@InstallEnd@!</pre> 
<p>После внесения изменений в файл конфигурации можно было бы упаковать все 3 файла снова в SFX архив, но... SFX архив может и не вывести предписанное сообщение, т.к. версия модуля, использованная для упаковки исходного архива, может быть более старой (или вообще <i>оригинальным SFX модулем архиватора 7-Zip</i>) и просто не поддерживать новые возможности, описанные в этой справке.</p>
<p>Лучше ВСЕГДА использовать последнюю версию модифицированного модуля, дабы избежать подобных ошибок. Однако есть аргументы и "за" использование "чужого" модуля:</p>
<ul>
	<li>Модуль уже с нужной иконкой
	<li>Размер модуля меньше, т.к. возможно уже сжат UPX-ом
	<li>"Копирайты" в ресурсах модуля приведены в соответствие с конкретным содержимым SFX архива 
	<li>Простая лень или незнание как все это сделать самостоятельно (хотя выше уже многое разъяснено) <IMG class=inlineimg alt="" src="misc/wink.gif"></li>
</ul>
<table>
<TBODY class="form">
	<TR>
		<td class="form"><p><IMG alt=Version src="misc/Version.png"></p></td>
		<td class="form"><p>Если эти аргументы перевешивают, то хотя бы узнайте версию модуля с помощью ключа '<A class=int href="switches.html#sfxversion">--sfxversion</A>'.<br>
		Обратите внимание на два знака "тире" перед ключом! В старых версиях модуля поддерживалось только такое написание ключа.</p>
		<p>Теперь, проверив возможности этой версии модуля в <A class=int href="history_b.html">истории изменений</A>, Вы увидите, что параметр '<tt>FinishMessage</tt>' появился только в сборке 457, а таймер для него (префикс '<tt>fmX</tt>') вообще только в сборке 549!</p>
		<p>Только после этого принимайте решение о возможности использования "чужого" модуля в вашем SFX архиве.</p></td>
	</TR>
</TBODY>
</table>
<p>Теперь Вы знаете ВСЕ о создании 7z SFX архивов! Ну, или почти все <IMG class=inlineimg alt="" src="misc/smile.gif">.</p>
<p>* При написании этого раздела справки использованы материалы статьи "<A href="http://oszone.net/display.php?id=3171#7zip" target="_blank" class="ext">Создание SFX архива</A>" с сайта <A href="http://oszone.net/" target="_blank" class="ext">OSZone</A>, автором которой является Вадим Стеркин aka <A href="http://forum.oszone.net/member.php?userid=22202" target="_blank" class="ext">Vadikan</A>, с его любезного согласия.</p>
<p>&nbsp;</p>
</BODY></HTML>